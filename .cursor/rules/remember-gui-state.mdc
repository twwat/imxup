---
description: GUI State Persistence
globs: imxup_gui.py
alwaysApply: true
---
## Core Rule
Persist complete main table state between sessions using SQLite database. No information loss on app restart.

## What Must Persist
- **Table items**: Status, progress, errors, metadata, visual indicators
- **Table layout**: Column widths, visibility, order, sorting
- **Window state**: Geometry, theme, user preferences
- **Queue state**: All gallery items with complete status/progress data

## Implementation
- **Database**: Use SQLite for all state data (galleries, images, settings tables)
- **QSettings**: Only for window geometry, theme, and UI preferences
- **Auto-save**: On close, resize, reorder, and state changes
- **Restore**: On startup and after database migrations

## Forbidden
- QSettings for queue/gallery data
- File-based state storage
- In-memory only state
- Partial state persistence

## Required Methods
```python
save_table_state()      # Persist complete table state to SQLite
restore_table_state()   # Restore from database on startup
save_item_state(item)   # Persist individual item state
migrate_state_schema()  # Handle database schema updates
```

## Key Points
- Single source of truth: SQLite database
- Atomic updates with transactions
- Async persistence for performance
- Error handling for corrupted state
- Validate all data before storage
